<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ISBN Scanner</title>
    <script src= "https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.js"></script>
</head>
<body>
    <form action="{{ url_for('logout') }}" method="get">
        <button type="submit">Logout</button>
    </form>

    <form action="{{ url_for('library') }}" method="get" style="display:inline;">
        <button type="submit">Go to My Library</button>
    </form>
    
    <h2>Scan the Barcode on the Back of a Book!</h2>    

    <div>
        <input type = "text" id ="search-query" placeholder="Search For a Book by Title, Author or ISBN...">
        <button onclick="searchBook()">Search</button>
    </div>

    <div id = "scanner" style="width: 100%; height: 100%;"></div>

    <div id="book-display" style="margin-top: 20px;"></div><hr>
    
    <!-- This is where the scanner is handled via Quagga -->
    <script>
        const scanned = new Set();
        Quagga.init({
            inputStream: {
                type: "LiveStream",
                target: document.querySelector('#scanner'),
                constraints: {
                    facingMode: "environment"
                }
            },
            decoder: {
                readers: ["ean_reader"]
            },
        }, function (err) {
            if (err) {
                console.error(err);
                return;
            }
            Quagga.start();
        });

    // Gurantees only an isbn will be scanned
        Quagga.onDetected((data) => {
            const code = data.codeResult.code;
            if ((code.startsWith("978") || code.startsWith("979")) && !scanned.has(code)) {
                scanned.add(code);
                alert("ISBN Scanned: " + code);
                fetch(`/items/${code}?partial=true`)
                    .then(response => response.json())
                    .then(book => {
                        const myList = document.getElementById("my-list");
                        const card = document.createElement("div");
                        card.classList.add("book-card");

                        if (book.isbn){
                            card.id = book.isbn;
                        }

                        card.style.border = "1px solid #ddd";
                        card.style.padding = "10px";
                        card.style.marginBottom = "15px";
                        card.style.borderRadius = "6px";
                        card.style.maxWidth = "300px";
                        card.style.flex = "0 0 auto";

                        card.innerHTML = `
                            <h3>${book.title}</h3>
                            <p><strong>Author(s):</strong> ${book.authors.join(", ")}</p>
                            ${book.cover ? `<img src="${book.cover}" alt="Cover of ${book.title}" style="width: 100%; height: auto;">` : ""}
                            <p><em>Source: ${book.source}</em></p>

                            <form action="/save_book" method="POST">
                                <input type="hidden" name="title" value="${book.title}">
                                ${book.authors.map(author => `<input type="hidden" name="authors" value="${author}">`).join("")}
                                <input type="hidden" name="isbn" value="${book.isbn}">
                                <input type="hidden" name="cover" value="${book.cover}">
                                <button type="submit">Save to Library</button>
                            </form>
                        `;

                        myList.appendChild(card);
                    })
                    .catch(error => {
                        console.error("Scan error:", error);
                        alert("Book not found or error occurred.");
                    });
            } else {
                console.log("Not an ISBN: " + code);
            }
        });

        function searchBook(){
            const query = document.getElementById("search-query").value;
            if (!query.trim()) return;

            fetch(`/search?q=${encodeURIComponent(query)}&partial=true`)
                .then(response => response.text())
                .then(html => {
                    const container = document.getElementById("book-display");
                    container.innerHTML = html;

        document.querySelectorAll(".add-button").forEach(button => {
            button.addEventListener("click", function () {
                const book = JSON.parse(this.dataset.book);

                const myList = document.getElementById("my-list");
                const card = document.createElement("div");
                card.classList.add("book-card");

                card.style.border = "1px solid #ddd";
                card.style.padding = "10px";
                card.style.marginBottom = "15px";
                card.style.borderRadius = "6px";
                card.style.maxWidth = "500px";

                card.innerHTML = `
                    <h3>${book.title}</h3>
                    <p><strong>Author(s):</strong> ${book.authors.join(", ")}</p>
                    ${book.cover ? `<img src="${book.cover}" alt="Cover of ${book.title}" style="width: 100%; height: auto;">` : ""}
                    <p><em>Source: ${book.source}</em></p>

                    <form action="/save_book" method="POST">
                        <input type="hidden" name="title" value="${book.title}">
                        ${book.authors.map(author => `<input type="hidden" name="authors" value="${author}">`).join("")}
                        <input type="hidden" name="isbn" value="${book.isbn}">
                        <input type="hidden" name="cover" value="${book.cover}">
                        <button type="submit">Save to Library</button>
                    </form>
                `;

                myList.appendChild(card);

                const container = document.getElementById("book-display");
                container.innerHTML = html;

                const searchHeader = container.querySelector("h2");
                if (searchHeader && searchHeader.textContent.trim() === "Search Results") {
                    searchHeader.remove();
                }

                document.getElementById("search-results").innerHTML = "";
            });
        });
    })
    .catch(error => {
        console.error("Search error:", error);
        alert("No book found. Try again!");
    });

        };
    </script>
</body>
</html>