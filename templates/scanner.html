<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ISBN Scanner</title>
    <script src= "https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.js"></script>
</head>
<body>
    <h2>Scan the Barcode on the Back of a Book!</h2>    
    <div id = "scanner" style="width: 100%; height: 100%;"></div>

    <div id="book-display" style="margin-top: 20px;"></div>
    <script>
        const scanned = new Set();
        Quagga.init({
            inputStream: {
                type: "LiveStream",
                target: document.querySelector('#scanner'),
                constraints: {
                    facingMode: "environment"
                }
            },
            decoder: {
                readers: ["ean_reader"]
            },
        }, function (err) {
            if (err) {
                console.error(err);
                return;
            }
            Quagga.start();
        });

        Quagga.onDetected((data)=> {
            const code = data.codeResult.code;
            if ((code.startsWith("978") || code.startsWith("979")) && !scanned.has(code)) {
                scanned.add(code);
                alert("ISBN Scanned: " + code);
                fetch(`/items/${code}?partial=true`)
                    .then(response => response.text())
                    .then(html => {
                        const container = document.getElementById("book-display");
                        const wrapper = document.createElement("div");
                        wrapper.innerHTML = html;
                        wrapper.style.marginBottom = "30px";
                        container.appendChild(wrapper);
                })
                .catch(error => console.error('Error:', error));
            } else {
                console.log("Not an ISBN:"+ code);
            }
        });
    </script>
</body>
</html>